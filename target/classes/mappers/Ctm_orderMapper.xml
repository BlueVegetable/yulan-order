<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yulan.dao.Ctm_orderDao">

    <sql id="Base_Column_List_H" >
    ORDER_NO, CUSTOMER_CODE, CUSTOMER_CODE2, CURRENCY_ID, NVL(LINKPERSON,' ') LINKPERSON , NVL(TELEPHONE,' ') TELEPHONE, STATUS_ID,
    DELIVERY_TYPE, DELIVERY_NOTES, POST_ADDRESS, NVL(NOTES,' ') NOTES, to_char(DATE_CRE,'yyyy-mm-dd hh24:mi:ss') DATE_CRE, OPERATOR, to_char(DATE_UPDATE,'yyyy-mm-dd hh24:mi:ss') DATE_UPDATE,
    PERSON_UPDATE, CONTRACT_NO, PERSON_ACCEPT, to_char(DATE_ACCEPT,'yyyy-mm-dd hh24:mi:ss') DATE_ACCEPT, NVL(YULAN_NOTES,' ') YULAN_NOTES, to_char(WEB_TJ_TIME,'yyyy-mm-dd hh24:mi:ss') WEB_TJ_TIME,
    DATE_DEAL, FLAG, USER_NO, PROJECT_NO, CUSTOMER_CODE_O2O, ORDER_FLAG, POST_ADDRESS_MODIFIED,
    DS_LINKMAN, DS_TEL, DS_USER_NAME, DS_ORDER_NO, IS_DS_ORDER, ERP_PROCESS_NOTE, INVOICE_FLAG,
    INVOICE_TITLE, NVL(WL_CONTACTS,' ') WL_CONTACTS, NVL(WL_TEL,' ') WL_TEL, RECIVER_AREA1, RECIVER_AREA2, RECIVER_AREA3,
    BILL_TYPE_X, DELIVERY_FLAG, OAO_FLAG, OAO_STATUS, OAO_PERSON,  to_char(OAO_TIME,'yyyy-mm-dd hh24:mi:ss') OAO_TIME,NVL(ALL_SPEND,0) ALL_SPEND,
    NVL(BUYUSER,' ') BUYUSER,NVL(BUYUSERPHONE,' ') BUYUSERPHONE
  </sql>
    <sql id="Base_Column_List_B" >
    ORDER_NO, LINE_NO, d.ITEM_NO, ITEM_NO_SAMPLE, PRODUCTION_VERSION, QTY_REQUIRED, NVL(to_char(DATE_DELIVER,'yyyy-mm-dd hh24:mi:ss'),' ') DATE_DELIVER,
    to_char(DATE_UPDATE,'yyyy-mm-dd hh24:mi:ss') DATE_UPDATE, NVL(NOTES,' ') NOTES, STATUS_ID, DISCOUNT, DISCOUNT_FLAG, CURTAIN_KS, CURTAIN_ROOM_NAME,
    CURTAIN_ROOM_ID, CURTAIN_ROOM_LINENO, CURTAIN_WIDTH, CURTAIN_HEIGHT, CURTAIN_HEIGHT2,
    CURTAIN_ITEM_MENU_NOTES, CURTAIN_MENU_GROUP_ID, CURTAIN_SIZE_TIMES, CURTAIN_SIZE_TIMES2,
    ML_NON_STANDARD, CURTAIN_WBH_SIZE, TRANS_TYPE, TRANS_ID,to_char(DATE_DELIVER_KF,'yyyy-mm-dd hh24:mi:ss') DATE_DELIVER_KF,to_char(DATE_DELIVER_NB,'yyyy-mm-dd hh24:mi:ss') DATE_DELIVER_NB,
    to_char(DATE_DELIVER_FH,'yyyy-mm-dd hh24:mi:ss') DATE_DELIVER_FH,NVL(UNIT_PRICE,0) UNIT_PRICE,NVL(PROMOTION_COST,0) PROMOTION_COST,NVL(PROMOTION,' ') PROMOTION,NVL(PART_SEND_ID,' ')PART_SEND_ID
  </sql>

    <select id="getOrders" resultType="Map">
        select * from (
        select rownum rn,l.* from
        (select * from
        (select b.brand_name,h.* from
        (select t.note,c.*  from
        (select o.*,i.product_type,i.product_brand from ctm_order_detail d,CTM_ORDER o, item i
        where o.order_no=d.order_no and d.item_no=i.item_no and o.customer_code=#{cid})c,item_type t
        where c.product_type=t.item_type)h,BRAND_TYPE b
        where h.product_brand=b.brand_id)p

        where 1=1
        <if test="state_id!=null">
            and STATUS_ID=#{state_id}
        </if>
        <if test="find!=null">
            and order_no like  '%'||#{find}||'%'
        </if>

        ) l
        where rownum &lt;= #{number})
        where rn &gt;=#{start}

    </select>

    <select id="getOrdersH" resultType="Map">
        select
         *

        from (
        select rownum rn,l.* from
        (select
        <include refid="Base_Column_List_H" />

        from CTM_ORDER t where t.customer_code=#{cid}
            <if test="state_id!=null">
                and STATUS_ID=#{state_id}
            </if>
            <if test="find!=null">
                and order_no like  '%'||#{find}||'%'
            </if>
            <if test="beginTime!=null">
                and DATE_CRE between to_date(#{beginTime},'yyyy/mm/dd') and to_date(#{finishTime},'yyyy/mm/dd')
            </if>
        order by t.DATE_CRE DESC
        ) l
        where rownum &lt;= #{number})
        where rn &gt;=#{start}

    </select>

    <select id="getOrdersB" resultType="Map">
        select b.brand_name,h.* from
        (select t.note,c.*  from
        (select
        <include refid="Base_Column_List_B" />,
        i.product_type,i.product_brand from item i, ctm_order_detail d
        where d.order_no=#{order_no} and d.item_no=i.item_no )c,item_type t
        where c.product_type=t.item_type)h,BRAND_TYPE b
        where h.product_brand=b.brand_id

    </select>

    <select id="countOrders" resultType="Integer">
        select count(*) from
        (select o.*,d.item_no from ctm_order_detail d,CTM_ORDER o where o.order_no=d.order_no and o.customer_code=#{cid} ) c
        where 1=1
        <if test="state_id!=null">
            and c.STATUS_ID=#{state_id}
        </if>
        <if test="find!=null">
            and c.order_no like  '%'||#{find}||'%'
        </if>


    </select>

    <select id="countOrdersH" resultType="Integer">
        select count(*) from CTM_ORDER t where t.customer_code=#{cid}
        <if test="state_id!=null">
            and STATUS_ID=#{state_id}
        </if>
        <if test="find!=null">
            and order_no like  '%'||#{find}||'%'
        </if>
        <if test="beginTime!=null">
            and date_cre between to_date(#{beginTime},'yyyy/mm/dd') and to_date(#{finishTime},'yyyy/mm/dd')
        </if>

    </select>

    <select id="getOrderB_content" resultType="Map">
        select b.brand_name,h.* from
        (select t.note,c.*  from
        (select
        <include refid="Base_Column_List_B" />,
        i.product_type,i.product_brand from item i, ctm_order_detail d
        where d.order_no=#{order_no} and d.item_no=#{item_on} and d.item_no=i.item_no  )c,item_type t
        where c.product_type=t.item_type)h,BRAND_TYPE b
        where h.product_brand=b.brand_id

    </select>

    <select id="getPromotion" resultType="Sal_promotion">
        select
          CUSTOMER_CODE, CUSTOMER_TYPE, ORDER_TYPE,
      ORDER_NAME, ITEM_NO, ITEM_VERSION,
      PRODUCT_TYPE, PRODUCT_BRAND, TYPE,
      DISCOUNT, PRICE, FALG_FL,
      QTY_ORDER, QTY_USE, FLAG_XH,
      FLAG_ZX, USE_ID,to_char(DATE_START,'yyyy-MM-dd') DATE_START,
      to_char(DATE_END,'yyyy-MM-dd')DATE_END, GROUP_TYPE,P_ID
         from SAL_PROMOTION t where t.p_id=#{pId}
    </select>
    
    <select id="getResideMoney" resultType="BigDecimal">
     select f_get_customer_money(#{cid}) from dual
    </select>

    <insert id="insertOrderH" parameterType="Ctm_order" >
    insert into CTM_ORDER (ORDER_NO, CUSTOMER_CODE, CUSTOMER_CODE2,
      CURRENCY_ID, LINKPERSON, TELEPHONE,
      STATUS_ID, DELIVERY_TYPE, DELIVERY_NOTES,
      POST_ADDRESS, NOTES, DATE_CRE,
      OPERATOR, DATE_UPDATE, PERSON_UPDATE,
      CONTRACT_NO, PERSON_ACCEPT, DATE_ACCEPT,
      YULAN_NOTES, WEB_TJ_TIME, DATE_DEAL,
      FLAG, USER_NO, PROJECT_NO,
      CUSTOMER_CODE_O2O, ORDER_FLAG, POST_ADDRESS_MODIFIED,
      DS_LINKMAN, DS_TEL, DS_USER_NAME,
      DS_ORDER_NO, IS_DS_ORDER, ERP_PROCESS_NOTE,
      INVOICE_FLAG, INVOICE_TITLE, WL_CONTACTS,
      WL_TEL, RECIVER_AREA1, RECIVER_AREA2,
      RECIVER_AREA3, BILL_TYPE_X, DELIVERY_FLAG,
      OAO_FLAG, OAO_STATUS, OAO_PERSON,
      OAO_TIME,ALL_SPEND,BUYUSER,BUYUSERPHONE)
    values (#{orderNo,jdbcType=VARCHAR}, #{customerCode,jdbcType=VARCHAR}, #{customerCode2,jdbcType=VARCHAR},
      #{currencyId,jdbcType=VARCHAR}, #{linkperson,jdbcType=VARCHAR}, #{telephone,jdbcType=VARCHAR},
      #{statusId,jdbcType=VARCHAR}, #{deliveryType,jdbcType=VARCHAR}, #{deliveryNotes,jdbcType=VARCHAR},
      #{postAddress,jdbcType=VARCHAR}, #{notes,jdbcType=VARCHAR}, #{dateCre,jdbcType=TIMESTAMP},
      #{operator,jdbcType=VARCHAR}, #{dateUpdate,jdbcType=TIMESTAMP}, #{personUpdate,jdbcType=VARCHAR},
      #{contractNo,jdbcType=VARCHAR}, #{personAccept,jdbcType=VARCHAR}, #{dateAccept,jdbcType=TIMESTAMP},
      #{yulanNotes,jdbcType=VARCHAR}, #{webTjTime,jdbcType=TIMESTAMP}, #{dateDeal,jdbcType=TIMESTAMP},
      #{flag,jdbcType=VARCHAR}, #{userNo,jdbcType=VARCHAR}, #{projectNo,jdbcType=VARCHAR},
      #{customerCodeO2o,jdbcType=VARCHAR}, #{orderFlag,jdbcType=VARCHAR}, #{postAddressModified,jdbcType=DECIMAL},
      #{dsLinkman,jdbcType=VARCHAR}, #{dsTel,jdbcType=VARCHAR}, #{dsUserName,jdbcType=VARCHAR},
      #{dsOrderNo,jdbcType=VARCHAR}, #{isDsOrder,jdbcType=VARCHAR}, #{erpProcessNote,jdbcType=VARCHAR},
      #{invoiceFlag,jdbcType=VARCHAR}, #{invoiceTitle,jdbcType=VARCHAR}, #{wlContacts,jdbcType=VARCHAR},
      #{wlTel,jdbcType=VARCHAR}, #{reciverArea1,jdbcType=VARCHAR}, #{reciverArea2,jdbcType=VARCHAR},
      #{reciverArea3,jdbcType=VARCHAR}, #{billTypeX,jdbcType=CHAR}, #{deliveryFlag,jdbcType=VARCHAR},
      #{oaoFlag,jdbcType=VARCHAR}, #{oaoStatus,jdbcType=VARCHAR}, #{oaoPerson,jdbcType=VARCHAR},
      #{oaoTime,jdbcType=TIMESTAMP},#{allSpend,jdbcType=DECIMAL},#{buyUser,jdbcType=VARCHAR},
      #{buyUserPhone,jdbcType=VARCHAR}
      )
  </insert>

    <insert id="insertOrderB" parameterType="Ctm_order_detail" >
    insert into CTM_ORDER_DETAIL (ORDER_NO, LINE_NO, ITEM_NO,
      ITEM_NO_SAMPLE, PRODUCTION_VERSION, QTY_REQUIRED,
      DATE_DELIVER, DATE_UPDATE, NOTES,
      STATUS_ID, DISCOUNT, DISCOUNT_FLAG,
      CURTAIN_KS, CURTAIN_ROOM_NAME, CURTAIN_ROOM_ID,
      CURTAIN_ROOM_LINENO, CURTAIN_WIDTH, CURTAIN_HEIGHT,
      CURTAIN_HEIGHT2, CURTAIN_ITEM_MENU_NOTES, CURTAIN_MENU_GROUP_ID,
      CURTAIN_SIZE_TIMES, CURTAIN_SIZE_TIMES2, ML_NON_STANDARD,
      CURTAIN_WBH_SIZE, TRANS_TYPE, TRANS_ID,
      DATE_DELIVER_KF, DATE_DELIVER_NB, DATE_DELIVER_FH,UNIT_PRICE,PROMOTION_COST,PROMOTION,
      PART_SEND_ID,BACK_Y,BACK_M
      )
    values (#{orderNo,jdbcType=VARCHAR}, #{lineNo,jdbcType=DECIMAL}, #{itemNo,jdbcType=VARCHAR},
      #{itemNoSample,jdbcType=VARCHAR}, #{productionVersion,jdbcType=VARCHAR}, #{qtyRequired,jdbcType=DECIMAL},
      #{dateDeliver,jdbcType=TIMESTAMP}, #{dateUpdate,jdbcType=TIMESTAMP}, #{notes,jdbcType=VARCHAR},
      #{statusId,jdbcType=VARCHAR}, #{discount,jdbcType=DECIMAL}, #{discountFlag,jdbcType=VARCHAR},
      #{curtainKs,jdbcType=VARCHAR}, #{curtainRoomName,jdbcType=VARCHAR}, #{curtainRoomId,jdbcType=DECIMAL},
      #{curtainRoomLineno,jdbcType=DECIMAL}, #{curtainWidth,jdbcType=DECIMAL}, #{curtainHeight,jdbcType=DECIMAL},
      #{curtainHeight2,jdbcType=DECIMAL}, #{curtainItemMenuNotes,jdbcType=VARCHAR}, #{curtainMenuGroupId,jdbcType=VARCHAR},
      #{curtainSizeTimes,jdbcType=DECIMAL}, #{curtainSizeTimes2,jdbcType=DECIMAL}, #{mlNonStandard,jdbcType=DECIMAL},
      #{curtainWbhSize,jdbcType=DECIMAL}, #{transType,jdbcType=VARCHAR}, #{transId,jdbcType=VARCHAR},
      #{dateDeliverKf,jdbcType=TIMESTAMP}, #{dateDeliverNb,jdbcType=TIMESTAMP}, #{dateDeliverFh,jdbcType=TIMESTAMP},
      #{unitPrice,jdbcType=DECIMAL},#{promotionCost,jdbcType=DECIMAL}, #{promotion,jdbcType=VARCHAR},
      #{partSendId,jdbcType=VARCHAR},#{backY,jdbcType=DECIMAL},#{backM,jdbcType=DECIMAL}
      )
  </insert>
    
    <select id="getPackDetail" resultType="Map">
        select SALE_NO,ITEM_NO,QTY_DELIVER,mc_get_ph(BATCH_NO)PH,to_char(DATE_OUT_STOCK,'yyyy-MM-dd HH:mm:ss')DATE_OUT_STOCK,TRANSCOMPANY,NVL(TRANS_ID,' ')TRANS_ID
       from PACK_DETAIL
       WHERE CUSTOMER_CODE = #{cid}
       AND WEB_ORDER_NO =#{order_no}
       and item_no = #{item_no}
    </select>

    <select id="getNum" resultType="BigDecimal">
        select QTY_REQUIRED from CTM_ORDER_DETAIL t where t.order_no=#{order_no} and t.item_no=#{item_no}
    </select>

    <update id="updateOrderStatus" parameterType="map">
        update CTM_ORDER t
        <set>
            <if test="STATUS_ID != null">
            STATUS_ID = #{STATUS_ID,jdbcType=VARCHAR},DATE_UPDATE=#{dateUpdate,jdbcType=TIMESTAMP}
            </if>
        </set>
        where ORDER_NO = #{ORDER_NO} and CUSTOMER_CODE = #{CUSTOMER_CODE}
    </update>

    <select id="getType_word" resultType="String">
        select 'Y'
            from item a,item_type b
            where a.product_type = b.item_type
            and b.pro_type in ('qiang','support','other')
            and a.item_no = #{item_no}
    </select>

    <select id="getBigNum" resultType="String">
        SELECT order_no FROM  CTM_ORDER t  WHERE t.date_cre = (SELECT MAX(date_cre) FROM  (SELECT * FROM  CTM_ORDER t  WHERE t.order_no like '%'||#{s}||'%'))
    </select>

    <select id="getlinkpersonandTel" resultType="Map">
        select t.customer_agent,t.office_tel from CUSTOMER t where t.customer_code=#{cid}
    </select>

    <resultMap id="rebateMap" type="Sal_rebate_certificate" >
        <id column="ID" property="id" jdbcType="VARCHAR" />
        <result column="REBATE_TYPE" property="rebateType" jdbcType="VARCHAR" />
        <result column="CUSTOMER_CODE" property="customerCode" jdbcType="VARCHAR" />
        <result column="REBATE_MONEY" property="rebateMoney" jdbcType="DECIMAL" />
        <result column="REBATE_MONEY_OVER" property="rebateMoneyOver" jdbcType="DECIMAL" />
        <result column="DATE_START" property="dateStart" jdbcType="TIMESTAMP" />
        <result column="DATE_END" property="dateEnd" jdbcType="TIMESTAMP" />
        <result column="STATUS" property="status" jdbcType="VARCHAR" />
        <result column="NOTES" property="notes" jdbcType="VARCHAR" />
        <result column="APPLICATION" property="application" jdbcType="VARCHAR" />
    </resultMap>
    <sql id="rebateList" >
    ID, REBATE_TYPE, CUSTOMER_CODE, REBATE_MONEY, REBATE_MONEY_OVER, to_char(DATE_START,'yyyy-MM-dd')DATE_START, to_char(DATE_END,'yyyy-MM-dd')DATE_END,
    STATUS,NOTES,APPLICATION
  </sql>
    <select id="getRebate" resultMap="rebateMap">
        select
        <include refid="rebateList" />
        from SAL_REBATE_CERTIFICATE t
        where t.customer_code=#{cid}
        and t.DATE_START &lt;=#{currentTime}
        and t.DATE_END &gt;=#{currentTime}
        and t.REBATE_MONEY_OVER!=0
        and  t.STATUS='1'
    </select>

    <select id="getRebateById" resultType="Sal_rebate_certificate">
        select
        <include refid="rebateList" />
        from SAL_REBATE_CERTIFICATE t
        where t.id=#{id}

    </select>

    <update id="updateRebatemoney" >
        update SAL_REBATE_CERTIFICATE t
          set t.REBATE_MONEY_OVER=#{rebateMoneyOver}
        where t.id=#{id}
    </update>

    <insert id="insertRebateRecord" parameterType="Sal_rebate_certificate_record">
        insert into SAL_REBATE_CERTIFICATE_RECORD
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                ID,
            </if>
            <if test="orderNo != null" >
                ORDER_NO,
            </if>
            <if test="lineNo != null" >
                LINE_NO,
            </if>
            <if test="rebateMoney != null" >
                REBATE_MONEY,
            </if>
            <if test="dateUse != null" >
                DATE_USE,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=VARCHAR},
            </if>
            <if test="orderNo != null" >
                #{orderNo,jdbcType=VARCHAR},
            </if>
            <if test="lineNo != null" >
                #{lineNo,jdbcType=DECIMAL},
            </if>
            <if test="rebateMoney != null" >
                #{rebateMoney,jdbcType=DECIMAL},
            </if>
            <if test="dateUse != null" >
                #{dateUse,jdbcType=TIMESTAMP},
            </if>
        </trim>
    </insert>


</mapper>